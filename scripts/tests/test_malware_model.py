"""
Test Malware Model - CyberGuard AI
Malware detection mod√ºl√º unit testleri

Dosya Yolu: scripts/tests/test_malware_model.py
"""

import os
import sys
import unittest
import numpy as np

# Proje root
current_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(os.path.dirname(current_dir))
if project_root not in sys.path:
    sys.path.insert(0, project_root)


class TestMalwareDetectionModel(unittest.TestCase):
    """MalwareDetectionModel testleri"""
    
    @classmethod
    def setUpClass(cls):
        """Test setup"""
        try:
            from src.malware_detection.model import MalwareDetectionModel
            cls.model_class = MalwareDetectionModel
            cls.can_test = True
        except ImportError as e:
            cls.can_test = False
            cls.skip_reason = str(e)
    
    def test_import(self):
        """Import testi"""
        if not self.can_test:
            self.skipTest(self.skip_reason)
        self.assertTrue(True)
    
    def test_model_creation(self):
        """Model olu≈üturma"""
        if not self.can_test:
            self.skipTest(self.skip_reason)
        
        model = self.model_class(model_type='gradient_boosting')
        self.assertIsNotNone(model)
        self.assertEqual(model.model_type, 'gradient_boosting')
    
    def test_model_training(self):
        """Model eƒüitimi (mock data)"""
        if not self.can_test:
            self.skipTest(self.skip_reason)
        
        try:
            model = self.model_class()
            
            # Mock data
            np.random.seed(42)
            X = np.random.rand(100, 5)
            y = np.random.randint(0, 2, 100)
            
            result = model.train(X, y)
            
            self.assertTrue(model.is_trained)
            self.assertIn('train_accuracy', result)
        except Exception as e:
            self.skipTest(f"Eƒüitim testi atlandƒ±: {e}")
    
    def test_model_prediction(self):
        """Model tahmini"""
        if not self.can_test:
            self.skipTest(self.skip_reason)
        
        try:
            model = self.model_class()
            
            # √ñnce eƒüit
            X = np.random.rand(100, 5)
            y = np.random.randint(0, 2, 100)
            model.train(X, y)
            
            # Tahmin
            X_test = np.random.rand(10, 5)
            predictions = model.predict(X_test)
            
            self.assertEqual(len(predictions), 10)
        except Exception as e:
            self.skipTest(f"Tahmin testi atlandƒ±: {e}")


class TestFileProcessor(unittest.TestCase):
    """FileProcessor testleri"""
    
    def test_import(self):
        """Import testi"""
        try:
            from src.malware_detection.file_processor import FileProcessor
            self.assertTrue(True)
        except ImportError as e:
            self.skipTest(f"Import hatasƒ±: {e}")
    
    def test_hash_calculation(self):
        """Hash hesaplama"""
        try:
            from src.malware_detection.file_processor import FileProcessor
            fp = FileProcessor()
            
            # Test i√ßin ge√ßici dosya
            test_content = b"test content"
            import hashlib
            expected_md5 = hashlib.md5(test_content).hexdigest()
            
            self.assertEqual(len(expected_md5), 32)  # MD5 32 karakter
        except ImportError:
            self.skipTest("FileProcessor import edilemedi")


class TestMalwareEvaluator(unittest.TestCase):
    """MalwareEvaluator testleri"""
    
    def test_import(self):
        """Import testi"""
        try:
            from src.malware_detection.evaluator import MalwareEvaluator
            self.assertTrue(True)
        except ImportError as e:
            self.skipTest(f"Import hatasƒ±: {e}")
    
    def test_evaluation(self):
        """Deƒüerlendirme testi"""
        try:
            from src.malware_detection.evaluator import MalwareEvaluator
            
            evaluator = MalwareEvaluator()
            
            y_true = np.array([0, 0, 1, 1, 0, 1])
            y_pred = np.array([0, 1, 1, 1, 0, 0])
            
            metrics = evaluator.evaluate(y_true, y_pred)
            
            self.assertIn('accuracy', metrics)
            self.assertIn('precision', metrics)
            self.assertIn('recall', metrics)
        except ImportError:
            self.skipTest("MalwareEvaluator import edilemedi")


def run_tests():
    """Testleri √ßalƒ±≈ütƒ±r"""
    print("\n" + "=" * 60)
    print("ü¶† MALWARE DETECTION MODEL TESTS")
    print("=" * 60 + "\n")
    
    loader = unittest.TestLoader()
    suite = unittest.TestSuite()
    
    suite.addTests(loader.loadTestsFromTestCase(TestMalwareDetectionModel))
    suite.addTests(loader.loadTestsFromTestCase(TestFileProcessor))
    suite.addTests(loader.loadTestsFromTestCase(TestMalwareEvaluator))
    
    runner = unittest.TextTestRunner(verbosity=2)
    result = runner.run(suite)
    
    print("\n" + "=" * 60)
    print(f"‚úÖ Passed: {result.testsRun - len(result.failures) - len(result.errors)}")
    print(f"‚ùå Failed: {len(result.failures)}")
    print(f"‚ö†Ô∏è  Errors: {len(result.errors)}")
    print(f"‚è≠Ô∏è  Skipped: {len(result.skipped)}")
    print("=" * 60)
    
    return result


if __name__ == "__main__":
    run_tests()
