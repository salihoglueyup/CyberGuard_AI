"""
Malware Model Training - CyberGuard AI
Malware detection modeli eÄŸitim scripti

Dosya Yolu: src/malware_detection/train.py
"""

import os
import sys
import numpy as np
import pandas as pd
from datetime import datetime
from typing import Dict, Optional

# Proje root
current_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(os.path.dirname(current_dir))
if project_root not in sys.path:
    sys.path.insert(0, project_root)

try:
    from sklearn.model_selection import train_test_split
    SKLEARN_AVAILABLE = True
except ImportError:
    SKLEARN_AVAILABLE = False

from src.malware_detection.model import MalwareDetectionModel
from src.malware_detection.evaluator import MalwareEvaluator


class MalwareTrainer:
    """
    Malware detection model eÄŸitimi
    
    Ã–zellikler:
    - Mock data generation
    - Model eÄŸitimi
    - DeÄŸerlendirme
    - Model kaydetme
    """
    
    def __init__(self, model_dir: str = 'models/malware'):
        """
        Args:
            model_dir: Model kayÄ±t dizini
        """
        self.model_dir = model_dir
        self.model = None
        self.evaluator = MalwareEvaluator()
        
        os.makedirs(model_dir, exist_ok=True)
        
        print("ğŸ¦  Malware Trainer baÅŸlatÄ±ldÄ±")
        print(f"ğŸ“ Model dizini: {model_dir}")
    
    def generate_mock_data(self, n_samples: int = 1000) -> tuple:
        """
        Mock eÄŸitim verisi oluÅŸtur
        
        Args:
            n_samples: Ã–rnek sayÄ±sÄ±
            
        Returns:
            X, y tuple
        """
        print(f"\nğŸ² Mock veri oluÅŸturuluyor ({n_samples} Ã¶rnek)...")
        
        np.random.seed(42)
        
        # Ã–zellikler: [file_size, entropy, is_suspicious_ext, is_pe, num_sections]
        # Benign dosyalar
        n_benign = n_samples // 2
        benign_features = np.column_stack([
            np.random.uniform(0.01, 5, n_benign),      # KÃ¼Ã§Ã¼k dosyalar
            np.random.uniform(3, 6, n_benign),          # DÃ¼ÅŸÃ¼k entropy
            np.random.choice([0, 1], n_benign, p=[0.9, 0.1]),  # Nadiren ÅŸÃ¼pheli uzantÄ±
            np.random.choice([0, 1], n_benign, p=[0.7, 0.3]),  # BazÄ±larÄ± PE
            np.random.uniform(0, 0.3, n_benign)         # Az section
        ])
        
        # Malware dosyalarÄ±
        n_malware = n_samples - n_benign
        malware_features = np.column_stack([
            np.random.uniform(0.1, 20, n_malware),     # DeÄŸiÅŸken boyut
            np.random.uniform(6.5, 8, n_malware),      # YÃ¼ksek entropy
            np.random.choice([0, 1], n_malware, p=[0.3, 0.7]),  # Genellikle ÅŸÃ¼pheli uzantÄ±
            np.random.choice([0, 1], n_malware, p=[0.2, 0.8]),  # Genellikle PE
            np.random.uniform(0.3, 1, n_malware)        # Ã‡ok section
        ])
        
        # BirleÅŸtir
        X = np.vstack([benign_features, malware_features])
        y = np.array([0] * n_benign + [1] * n_malware)
        
        # Shuffle
        indices = np.random.permutation(len(X))
        X = X[indices]
        y = y[indices]
        
        print(f"âœ… Veri oluÅŸturuldu: {len(X)} Ã¶rnek, {X.shape[1]} Ã¶zellik")
        print(f"   Benign: {np.sum(y == 0)}, Malware: {np.sum(y == 1)}")
        
        return X, y
    
    def train(
        self,
        X: np.ndarray = None,
        y: np.ndarray = None,
        n_samples: int = 1000,
        test_size: float = 0.2,
        model_type: str = 'gradient_boosting',
        use_neural_network: bool = False,
        epochs: int = 50
    ) -> Dict:
        """
        Model eÄŸit
        
        Args:
            X: Ã–zellikler (None ise mock data)
            y: Etiketler
            n_samples: Mock data Ã¶rnek sayÄ±sÄ±
            test_size: Test seti oranÄ±
            model_type: Model tÃ¼rÃ¼
            use_neural_network: NN kullan
            epochs: NN epochs
            
        Returns:
            EÄŸitim sonuÃ§larÄ±
        """
        if not SKLEARN_AVAILABLE:
            raise RuntimeError("scikit-learn yÃ¼klÃ¼ deÄŸil!")
        
        # Veri hazÄ±rla
        if X is None or y is None:
            X, y = self.generate_mock_data(n_samples)
        
        # Train/test split
        X_train, X_test, y_train, y_test = train_test_split(
            X, y, test_size=test_size, random_state=42, stratify=y
        )
        
        print(f"\nğŸ“Š Veri bÃ¶lÃ¼nmesi:")
        print(f"   Train: {len(X_train)} Ã¶rnek")
        print(f"   Test:  {len(X_test)} Ã¶rnek")
        
        # Model oluÅŸtur ve eÄŸit
        self.model = MalwareDetectionModel(
            model_type=model_type,
            use_neural_network=use_neural_network
        )
        
        train_results = self.model.train(
            X_train, y_train,
            epochs=epochs
        )
        
        # DeÄŸerlendir
        print("\nğŸ“Š Test seti deÄŸerlendirmesi...")
        y_pred = self.model.predict(X_test)
        y_pred_proba = self.model.predict(X_test, return_proba=True)
        
        eval_metrics = self.evaluator.evaluate(y_test, y_pred, y_pred_proba)
        self.evaluator.print_report(eval_metrics)
        
        # Kaydet
        model_path = self.model.save(self.model_dir)
        
        results = {
            'train_results': train_results,
            'eval_metrics': eval_metrics,
            'model_path': model_path,
            'trained_at': datetime.now().isoformat()
        }
        
        print(f"\nâœ… EÄŸitim tamamlandÄ±!")
        print(f"   Accuracy: {eval_metrics['accuracy']:.4f}")
        print(f"   F1-Score: {eval_metrics['f1_score']:.4f}")
        
        return results


def main():
    """Ana fonksiyon - Ä°nteraktif menÃ¼"""
    
    print("\n" + "=" * 60)
    print("ğŸ¦  CYBERGUARD AI - MALWARE MODEL EÄÄ°TÄ°M")
    print("=" * 60)
    
    print("\nğŸ“‹ SeÃ§enekler:")
    print("  1. Yeni model eÄŸit (mock data)")
    print("  2. Mevcut modeli test et")
    print("  3. Ã‡Ä±kÄ±ÅŸ")
    
    choice = input("\nSeÃ§iminiz (1-3): ").strip()
    
    if choice == '1':
        # Parametreler
        n_samples = int(input("Ã–rnek sayÄ±sÄ± [1000]: ").strip() or "1000")
        model_type = input("Model tÃ¼rÃ¼ (gradient_boosting/random_forest) [gradient_boosting]: ").strip() or "gradient_boosting"
        
        trainer = MalwareTrainer()
        results = trainer.train(
            n_samples=n_samples,
            model_type=model_type
        )
        
        print(f"\nğŸ‰ Model kaydedildi: {results['model_path']}")
        
    elif choice == '2':
        model_dir = input("Model dizini [models/malware]: ").strip() or "models/malware"
        
        if os.path.exists(model_dir):
            model = MalwareDetectionModel.load(model_dir)
            
            # Test
            test_features = [0.5, 7.2, 1, 1, 0.6]  # ÅÃ¼pheli
            result = model.predict_single(test_features)
            print(f"\nğŸ“Š Test sonucu: {result}")
        else:
            print("âŒ Model bulunamadÄ±!")
            
    elif choice == '3':
        print("\nğŸ‘‹ Ã‡Ä±kÄ±ÅŸ...")
    else:
        print("âŒ GeÃ§ersiz seÃ§im!")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nâš ï¸ Ä°ptal edildi!")
    except Exception as e:
        print(f"\nâŒ HATA: {e}")
        import traceback
        traceback.print_exc()
