"""
Malware Scanner - CyberGuard AI
Dosya tarama ve malware tespiti

Dosya Yolu: src/malware_detection/scanner.py
"""

import os
import json
from typing import Dict, List, Optional
from datetime import datetime
from pathlib import Path

from .file_processor import FileProcessor
from .model import MalwareDetectionModel


class MalwareScanner:
    """
    Malware tarama sistemi
    
    Ã–zellikler:
    - Tekli dosya tarama
    - KlasÃ¶r tarama
    - Karantina
    - Tarama geÃ§miÅŸi
    - Bilinen hash kontrolÃ¼
    """
    
    # Bilinen malware hash'leri (Ã¶rnek)
    KNOWN_MALWARE_HASHES = {
        # Ã–rnek hash'ler - gerÃ§ek uygulamada bir veritabanÄ±ndan Ã§ekilir
        'e3b0c44298fc1c149afbf4c8996fb924': 'Eicar Test Virus',
        '44d88612fea8a8f36de82e1278abb02f': 'Eicar Extended',
    }
    
    def __init__(
        self,
        model_path: Optional[str] = None,
        quarantine_dir: str = 'quarantine'
    ):
        """
        Args:
            model_path: EÄŸitilmiÅŸ model yolu
            quarantine_dir: Karantina klasÃ¶rÃ¼
        """
        self.file_processor = FileProcessor()
        self.model = None
        self.quarantine_dir = quarantine_dir
        self.scan_history: List[Dict] = []
        
        # Karantina klasÃ¶rÃ¼ oluÅŸtur
        os.makedirs(quarantine_dir, exist_ok=True)
        
        # Model yÃ¼kle
        if model_path and os.path.exists(model_path):
            try:
                self.model = MalwareDetectionModel.load(model_path)
            except Exception as e:
                print(f"âš ï¸ Model yÃ¼klenemedi: {e}")
        
        print("ğŸ›¡ï¸ Malware Scanner baÅŸlatÄ±ldÄ±")
    
    def check_known_hash(self, file_hash: str) -> Optional[str]:
        """
        Bilinen malware hash'lerini kontrol et
        
        Args:
            file_hash: MD5 hash
            
        Returns:
            Malware adÄ± veya None
        """
        return self.KNOWN_MALWARE_HASHES.get(file_hash.lower())
    
    def scan_file(self, file_path: str) -> Dict:
        """
        Tek dosya tara
        
        Args:
            file_path: Dosya yolu
            
        Returns:
            Tarama sonucu
        """
        if not os.path.exists(file_path):
            return {
                'status': 'error',
                'message': 'Dosya bulunamadÄ±',
                'file_path': file_path
            }
        
        print(f"ğŸ” TaranÄ±yor: {os.path.basename(file_path)}")
        
        result = {
            'file_path': file_path,
            'file_name': os.path.basename(file_path),
            'scan_time': datetime.now().isoformat(),
            'status': 'clean',
            'threat_name': None,
            'threat_level': 'safe',
            'details': {}
        }
        
        try:
            # Dosya Ã¶zelliklerini Ã§Ä±kar
            features = self.file_processor.extract_all_features(file_path)
            result['details'] = features
            
            # 1. Bilinen hash kontrolÃ¼
            known_threat = self.check_known_hash(features['hashes']['md5'])
            if known_threat:
                result['status'] = 'infected'
                result['threat_name'] = known_threat
                result['threat_level'] = 'critical'
                result['detection_method'] = 'hash_match'
                return result
            
            # 2. Entropy kontrolÃ¼
            if features['entropy'] > 7.8:
                result['threat_level'] = 'suspicious'
                result['details']['high_entropy_warning'] = True
            
            # 3. ÅÃ¼pheli uzantÄ± kontrolÃ¼
            if features['file_info']['is_suspicious_ext']:
                if result['threat_level'] == 'safe':
                    result['threat_level'] = 'low'
            
            # 4. ML model tahmini
            if self.model and self.model.is_trained:
                feature_vector = self.file_processor.get_feature_vector(file_path)
                prediction = self.model.predict_single(feature_vector)
                
                result['ml_prediction'] = prediction
                
                if prediction['is_malware']:
                    result['status'] = 'infected'
                    result['threat_level'] = 'high' if prediction['confidence'] > 0.8 else 'medium'
                    result['threat_name'] = 'ML_Detected_Threat'
                    result['detection_method'] = 'ml_model'
            
        except Exception as e:
            result['status'] = 'error'
            result['message'] = str(e)
        
        # GeÃ§miÅŸe ekle
        self.scan_history.append(result)
        
        return result
    
    def scan_directory(
        self,
        directory: str,
        recursive: bool = True,
        extensions: Optional[List[str]] = None
    ) -> Dict:
        """
        KlasÃ¶r tara
        
        Args:
            directory: KlasÃ¶r yolu
            recursive: Alt klasÃ¶rleri de tara
            extensions: Sadece bu uzantÄ±larÄ± tara
            
        Returns:
            Tarama Ã¶zeti
        """
        if not os.path.isdir(directory):
            return {'status': 'error', 'message': 'KlasÃ¶r bulunamadÄ±'}
        
        print(f"ğŸ“‚ KlasÃ¶r taranÄ±yor: {directory}")
        
        summary = {
            'directory': directory,
            'scan_time': datetime.now().isoformat(),
            'total_files': 0,
            'scanned_files': 0,
            'clean_files': 0,
            'infected_files': 0,
            'suspicious_files': 0,
            'errors': 0,
            'threats': []
        }
        
        # DosyalarÄ± topla
        if recursive:
            files = Path(directory).rglob('*')
        else:
            files = Path(directory).glob('*')
        
        for file_path in files:
            if not file_path.is_file():
                continue
            
            summary['total_files'] += 1
            
            # UzantÄ± filtresi
            if extensions:
                if file_path.suffix.lower() not in extensions:
                    continue
            
            # Tara
            result = self.scan_file(str(file_path))
            summary['scanned_files'] += 1
            
            if result['status'] == 'clean':
                summary['clean_files'] += 1
            elif result['status'] == 'infected':
                summary['infected_files'] += 1
                summary['threats'].append({
                    'file': result['file_name'],
                    'threat': result['threat_name'],
                    'level': result['threat_level']
                })
            elif result['status'] == 'error':
                summary['errors'] += 1
            
            if result['threat_level'] in ['suspicious', 'low', 'medium']:
                summary['suspicious_files'] += 1
        
        # Ã–zet
        print(f"\nğŸ“Š Tarama Ã–zeti:")
        print(f"   Toplam: {summary['total_files']} dosya")
        print(f"   Taranan: {summary['scanned_files']} dosya")
        print(f"   âœ… Temiz: {summary['clean_files']}")
        print(f"   âš ï¸ ÅÃ¼pheli: {summary['suspicious_files']}")
        print(f"   âŒ Enfekte: {summary['infected_files']}")
        
        return summary
    
    def quarantine_file(self, file_path: str) -> Dict:
        """
        DosyayÄ± karantinaya al
        
        Args:
            file_path: Dosya yolu
            
        Returns:
            SonuÃ§
        """
        if not os.path.exists(file_path):
            return {'status': 'error', 'message': 'Dosya bulunamadÄ±'}
        
        try:
            import shutil
            
            filename = os.path.basename(file_path)
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            quarantine_name = f"{timestamp}_{filename}.quarantine"
            quarantine_path = os.path.join(self.quarantine_dir, quarantine_name)
            
            # TaÅŸÄ±
            shutil.move(file_path, quarantine_path)
            
            # Metadata kaydet
            metadata = {
                'original_path': file_path,
                'quarantine_path': quarantine_path,
                'quarantine_time': datetime.now().isoformat()
            }
            
            with open(quarantine_path + '.meta', 'w') as f:
                json.dump(metadata, f, indent=2)
            
            print(f"ğŸ”’ Karantinaya alÄ±ndÄ±: {filename}")
            
            return {
                'status': 'success',
                'original_path': file_path,
                'quarantine_path': quarantine_path
            }
            
        except Exception as e:
            return {'status': 'error', 'message': str(e)}
    
    def get_scan_history(self, limit: int = 10) -> List[Dict]:
        """Son tarama geÃ§miÅŸini getir"""
        return self.scan_history[-limit:]
    
    def get_statistics(self) -> Dict:
        """Tarama istatistikleri"""
        if not self.scan_history:
            return {'total_scans': 0}
        
        infected = sum(1 for s in self.scan_history if s['status'] == 'infected')
        clean = sum(1 for s in self.scan_history if s['status'] == 'clean')
        
        return {
            'total_scans': len(self.scan_history),
            'infected_count': infected,
            'clean_count': clean,
            'detection_rate': infected / len(self.scan_history) if self.scan_history else 0
        }


# Test
if __name__ == "__main__":
    print("ğŸ§ª Malware Scanner Test\n")
    
    scanner = MalwareScanner()
    
    # Test dosyasÄ± oluÅŸtur
    test_file = "test_scan_file.txt"
    with open(test_file, 'w') as f:
        f.write("Bu bir test dosyasÄ±dÄ±r.")
    
    # Tara
    result = scanner.scan_file(test_file)
    print(f"\nğŸ“Š SonuÃ§: {result['status']}")
    print(f"   Tehdit seviyesi: {result['threat_level']}")
    
    # Temizlik
    os.remove(test_file)
    
    # Ä°statistikler
    print(f"\nğŸ“ˆ Ä°statistikler: {scanner.get_statistics()}")
